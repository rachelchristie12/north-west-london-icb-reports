---
title: "North West London Population Health and Health Equity Outcomes Report"
date: "`r Sys.Date()`"
author: "Rachel Christie - Health Equity Team"
date-format: "D MMMM YYYY"
format:
  html:
    # Table of Contents options
    toc: true
    toc-depth: 3
    toc-location: left
    toc-title: Contents
    number-sections: false
    number-depth: 3
    # Render options
    theme: cosmo
    grid:
      body-width: 800px
    css: NHS_report_theme.css
    anchor-sections: false
    html-math-method: katex
    # Code options
    code-tools:
      source: false
      toggle: false
      caption: none
    # code-fold: false
    # code-summary: "Show code"
    embed-resources: true
    standalone: true
    # URL options
    link-external-icon: true
    link-external-newwindow: true
    # Reference options
    citations-hover: true
    footnotes-hover: true
    # Callout options
    callout-appearance: simple
    callout-collapse: true
    # Caption options
    cap-location: bottom
    # Title options
    title-block-banner: '#005EB8'
    backgroundcolor: '#f0f4f5'
    # Set font
    mainfont: 'Open Sans'
    # include-in-header: |
    #   <style> -->
    #     .logo { position: absolute; top: 10px; left: 10px; width: 80px; } 
    #   </style>
    #   <img src="images/NWL_NHS_White.png" class="logo"> 
execute:
  echo: false
  warning: false
  message: false
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
---

```{r set up}
#| echo: false
#| error: false

## Packages and src
pacman::p_load(dplyr, janitor,ggplot2, fingertipsR, leaflet, sf,
               gt, gtExtras, plotly)
#flextable, kable
source("C:/nhs-nwl-icb-health-equity/src/data_cleaning.R")
source("C:/nhs-nwl-icb-health-equity/src/plot_theme.R")
source("C:/nhs-nwl-icb-health-equity/src/geography_functions.R")

#output_path <- "C:/nwlicb/outputs/health_equity_outcomes/"

## General data 
nwl_code_list <- get_north_west_london_code()
msoa_shape <- ingest_shape_date(geography="msoa", filter_codes = nwl_code_list$msoa_codes_11, all_codes = nwl_code_list$nwl_all_codes)
lad_shape <- ingest_shape_date(geography="lad", filter_codes = nwl_code_list$lad_codes_21, all_codes = nwl_code_list$nwl_all_codes)

```

## Introduction

This report outlines the health equity program outcomes which are :

-   Elongate healthy life as long as possible for people from our most deprived communities

-   Stop communities dying from causes that can be prevented and that are prevented in more affluent areas

-   Enable and empower communities to manage their health so their health conditions do not affect their day-to-day life

-   Improve the experience of accessing NHS healthcare for our most deprived communities

## Elongate healthy life

### Life expectancy

Life expectancy is a key measure of population health because it reflects the overall impact of mortality across all age groups and highlights the effects of social determinants like income, education, and access to healthcare. Research into the life expectancies in small geographies across England has show that the areas in which life expectancy has increased the least since 2002 were the ones that has the lowest life expectancy in the first place and in those areas that are most socioeconomically deprived ([The Lancet Public Health](https://www.sciencedirect.com/science/article/pii/S246826672100205X#sec1)).

Variations in life expectancy reveal inequalities within and between populations, pointing to systemic disparities in resources and living conditions. As a simple and comparable metric, it provides valuable insights into societal progress, while also emphasizing the need to address the root causes of health inequities.

```{r life_expectancy}
#| echo: false
#| error: false
#fingertips_profiles <-  profiles(proxy_settings = "none")

life_expectancy_msoa <- fingertips_data(IndicatorID = c(93283), AreaTypeID = 3, proxy_settings = "none", AreaCode = nwl_code_list$msoa_codes_11) %>% 
  janitor::clean_names() 

life_expectancy_lad <- fingertips_data(IndicatorID = c(90366), AreaTypeID = 401, proxy_settings = "none", AreaCode = nwl_code_list$lad_codes_21) %>% 
  janitor::clean_names()

life_expectancy_compare <- fingertips_data(IndicatorID = c(90366), AreaTypeID = 6, proxy_settings = "none", AreaCode = "E12000007") %>% 
  janitor::clean_names()

lad_diff_le <- life_expectancy_lad %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))+2) %>% 
  dplyr::group_by(year) %>% 
  #filter(timeperiod_sortable==max(timeperiod_sortable)) %>% 
  summarise(diff=max(value)-min(value))

msoa_diff_le <- life_expectancy_msoa %>% 
  filter(timeperiod_sortable==max(timeperiod_sortable)) %>% 
  summarise(diff=max(value)-min(value))

life_expectancy_compare_clean <-life_expectancy_compare %>% 
  dplyr::filter(sex!="Persons" & timeperiodrange=="3y") %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))+2) %>% 
  dplyr::select(year, sex, value, lower_ci95_0limit, upper_ci95_0limit) %>% 
  dplyr::mutate(is_national="London average")

life_expectancy_nwl <- life_expectancy_lad %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))+2) %>% 
  dplyr::group_by(sex, year) %>% 
  dplyr::summarise(across(c(value, lower_ci95_0limit, upper_ci95_0limit), ~mean(.x, na.rm = TRUE)))  %>% 
  dplyr::mutate(is_national="NWL") %>% 
  dplyr::bind_rows(life_expectancy_compare_clean)

life_expectancy_inequality <- life_expectancy_lad %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))+2) %>% 
  dplyr::group_by(sex, year) %>% 
  dplyr::summarise(differnce=max(value)-min(value))

nwl_female_shape <- msoa_shape %>% 
  left_join(life_expectancy_msoa %>% 
              dplyr::filter(sex=="Female"), by=c("msoa11cd"="area_code")) %>% 
  sf::st_transform(crs = 4326) %>% 
  sf::st_simplify(dTolerance = 50) 


nwl_male_shape <- msoa_shape %>% 
  left_join(life_expectancy_msoa %>% 
              dplyr::filter(sex=="Male"), by=c("msoa11cd"="area_code")) %>% 
  sf::st_transform(crs = 4326)  %>% 
  st_simplify(dTolerance = 50) 


```

```{r life_expecantcy_plot}
#| echo: false
#| fig-width: 10
#| error: false 
p1 <- life_expectancy_nwl %>% 
  mutate(is_national = factor(is_national, levels = c("NWL", "London average"))) %>% 
  ggplot(aes(x=year, y=value, ymin=lower_ci95_0limit, ymax=upper_ci95_0limit)) +
  #geom_point(aes(color=sex)) +
  geom_line(aes(color=sex, linetype = is_national)) +
  geom_ribbon(aes(fill=sex, alpha=is_national))+
  scale_color_manual(values = c("Female"="#41B6E6", "Male"="#009639")) +
  scale_fill_manual(values = c("Female"="#41B6E6", "Male"="#009639")) +
  scale_alpha_manual(values= c("NWL"=0.3, "London average"=0.2)) +
  scale_linetype_manual(values = c("NWL" = "solid", "London average" = "dashed")) +  # Explicitly set line types
  scale_x_continuous(breaks = seq(min(life_expectancy_nwl$year), max(life_expectancy_nwl$year),2)) +
  #theme_nwl() +
  theme_classic() +
  labs(x="Year",
       y="Life expectancy (years)",
       color="",
       fill="",
       linetype="",
       alpha="",
       title="Life expectancy (3-year) at birth for North West London (NWL)",
       caption="Source: OHID") 
  #guides(linetype = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

  ggplotly(p1, tooltip = c("text", "x", "y"))

```
<br>
The graph shows the life expectancy for males and females in North West London from 2001-03 to 2021-23 compared to London. The shaded ribbons represent the 95% confidence intervals. Over the last 20 years life expectancy has increased from `r sprintf("%.1f", life_expectancy_nwl$value[life_expectancy_nwl$year==max(life_expectancy_nwl$year)-20 & life_expectancy_nwl$is_national=="NWL" & life_expectancy_nwl$sex=="Male"])` to `r sprintf("%.1f", life_expectancy_nwl$value[life_expectancy_nwl$year==max(life_expectancy_nwl$year) & life_expectancy_nwl$is_national=="NWL" & life_expectancy_nwl$sex=="Male"])` in males and `r sprintf("%.1f", life_expectancy_nwl$value[life_expectancy_nwl$year==max(life_expectancy_nwl$year)-20 & life_expectancy_nwl$is_national=="NWL" & life_expectancy_nwl$sex=="Female"])` to `r sprintf("%.1f", life_expectancy_nwl$value[life_expectancy_nwl$year==max(life_expectancy_nwl$year) & life_expectancy_nwl$is_national=="NWL" & life_expectancy_nwl$sex=="Female"])`to in females. From around 2014-16 the trend in life expectancy in males and females plateaued and then decreased from 2020-22, likely due to the pandemic. We can see life expectancy beginning to recover post-pandemic with a slight increase in 2021-23.

The difference in life expectancy between boroughs has fluctuated over time, although has seen an overall decrease over the last 20 years. The difference in life expectancy in males has been higher than females over the last 10 years, however, due to a increase in inequality in females in 2020-22 the inequalities in life expectancy between males and females are similar.
```{r le_inequlaity_borough}

p2 <- life_expectancy_inequality %>% 
  ggplot(aes(x=year, y=differnce)) +
  geom_point(aes(color=sex)) +
  geom_line(aes(color=sex)) +
  scale_color_manual(values = c("Female"="#41B6E6", "Male"="#009639")) +
  scale_x_continuous(breaks = seq(min(life_expectancy_inequality$year), max(life_expectancy_inequality$year),2)) +
  theme_classic() +
  ylim(0,NA) +
  labs(x="Year",
       y="Difference in life expectancy (years)",
       color="Sex",
       fill="Sex",
       linetype="",
       title="Difference in life expectancy (3-year) at birth between NWL boroughs",
       caption="Source: OHID")
ggplotly(p2, tooltip = c("text", "x", "y"))


```
<br>

Life expectancy varies greatly within North West London; with a gap of \~20 year between Notting Dale and Knightsbridge for both males and female. Those in more deprived neighborhoods, on average, have a lower life expectancy compared to those living in more affluent areas. There is currently a `r sprintf("%.1f",  lad_diff_le$diff[lad_diff_le$year==max(lad_diff_le$year)])` difference in life expectancy between boroughs and a `r sprintf("%.1f",  msoa_diff_le$diff)` difference between smaller geographies MSOA (this data is not available over time).

```{r life_expectancy_map_f}
#| echo: false
#| error: false
pal <- colorNumeric("viridis", domain = nwl_female_shape$value, na.color = "transparent")
leaflet(nwl_female_shape,  options = leafletOptions(preferCanvas = TRUE)) %>%
  addTiles() %>% 
  addPolygons(
    fillColor = ~pal(value),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.2,
    highlight = highlightOptions(weight = 3, color = "red", bringToFront = TRUE),
    label = ~paste0("Life Expectancy: ", round(value, 1))
  ) %>%
  addLegend(
    pal = pal, values = ~value, title = "Female Life Expectancy (2016-2020)", position = "bottomright"
  )
```

```{r life_expectancy_map_m}

pal <- colorNumeric("viridis", domain = nwl_male_shape$value, na.color = "transparent")

leaflet(nwl_male_shape) %>%
  addTiles() %>% 
  addPolygons(
    fillColor = ~pal(value),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.2,
    highlight = highlightOptions(weight = 3, color = "red", bringToFront = TRUE),
    label = ~paste0("Life Expectancy: ", round(value, 1))
  ) %>%
  addLegend(
    pal = pal, values = ~value, title = "Male Life Expectancy (2016-2020)", position = "bottomright"
  )
```

### Healthy life expectancy

```{r healthlife}

hle_deprivation <- read.csv("C:/nhs-nwl-icb-health-equity/health_equity_outcomes/data/healthy_life_deprivation.csv") %>%
  janitor::clean_names()

hle_df <-  read.csv("C:/nhs-nwl-icb-health-equity/health_equity_outcomes/data/healthy_life.csv")

hle_50 <- hle_df %>% 
  dplyr::filter(value>50) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(min_age=min(age))


hle_deprivation_50 <- hle_deprivation %>% 
  dplyr::filter(value>50) %>% 
  dplyr::group_by(quintile , year) %>% 
  dplyr::summarise(min_age=min(age)) %>% 
  dplyr::left_join(hle_deprivation, by=c("quintile"="quintile", "min_age"="age", "year"="year"))

hle_deprivation_50_current_diff  <- hle_deprivation_50 %>% 
    dplyr::group_by(year) %>% 
    dplyr::summarise(diff=max(min_age)-min(min_age))

  
```

The health equity program aims to increase healthy life expectancy for all its residents and reduce the gap in healthy life expectancy between the most and least deprived populations.

The percentage of the population with 2+ LTCs is a measure of ill-health and therefore healthy life expectancy. The graph below displays the percentage of the population with 2+ LTC by age and deprivation quintile. The graph demonstrates how the more deprived quintiles (1 +2) develop multi-morbidity earlier than the less deprived populations (4+5). The most deprived community known as the Core 20 population (quintile 1) reports 50% of its population being multi-morbid at age 56, whereas the least deprived community (quintile 5) reports this statistic at age 65. This is a 9 year difference.


```{r hle_graphs}

p3 <- hle_deprivation %>% 
  mutate(quintile = factor(quintile, levels = sort(unique(quintile)))) %>% 
  dplyr::filter(year==max(year) & !is.na(quintile) & age< 100) %>% 
  ggplot(aes(x=age, y=value, color=factor(quintile), fill=factor(quintile))) +
  geom_line() +
  geom_ribbon(aes(ymin=lowercl, ymax=uppercl), alpha=0.3,show.legend = FALSE) +
  theme_classic() +
  xlim(0,100) +
  scale_color_manual(name = "Deprivation (1=most deprived)",values = c("1"="#1b9e77", "2"="#d95f02", "3"="#7570b3", "4"="#e7298a", "5"="#66a61e")) +  # Adjust colors
  scale_fill_manual(name = "Deprivation (1=most deprived)", values = c("1"="#1b9e77", "2"="#d95f02", "3"="#7570b3", "4"="#e7298a", "5"="#66a61e")) +
  labs(x="Year",
       y="Percentage of the population with 2+ LTCS (%)",
       # color="Deprivation (1=most deprived)",
       # fill="Deprivation (1=most deprived)",
       title=paste0("Percentage of the population in ill-health by age and deprivation (",max(hle_deprivation$year),")"),
       caption="Source: WSIC") +
  theme(legend.position = "bottom")

ggplotly(p3, tooltip = c( "x", "y")) 
  
p3_plotly <- ggplotly(p3)

```

<br> 
The bar graph represents the age at which 50% of the population is multi-morbid by quintiles for 2022 to 2024. This shows us that for the last three years the healthy life expectancy and the gap in healthy life expectancy have remained stable


```{r hle_graphs_2}
p4 <- hle_deprivation_50 %>% 
  mutate(quintile = factor(quintile, levels = sort(unique(quintile)))) %>% 
  dplyr::filter(year > max(year)-3 & !is.na(quintile)) %>% 
  ggplot(aes(x=year, y=min_age, fill=quintile)) +
  geom_col(position = position_dodge(0.9)) +
  #geom_errorbar(aes(ymin = lowercl, ymax=uppercl), width=0.5, position = position_dodge(0.9))+
  scale_fill_manual(name = "Deprivation (1=most deprived)", values = c("1"="#1b9e77", "2"="#d95f02", "3"="#7570b3", "4"="#e7298a", "5"="#66a61e")) +
  theme_classic() +
  labs(x="Year",
       y="Age",
       # color="Deprivation (1=most deprived)",
       # fill="Deprivation (1=most deprived)",
       title="Age of which 50% of the population is in ill-health",
       caption="Source: WSIC") +
  theme(legend.position = "bottom")

ggplotly(p4, tooltip = c( "x", "y")) 

# Manually remove extra legend items by filtering traces

```

<!-- ::::: grid -->
<!-- ::: g-col-6 -->
<!-- ![Source: WSIC](images/healthy_life/quintile_age_cat%20(2).png){fig-align="center"} -->
<!-- ::: -->

<!-- ::: g-col-6 -->
<!-- ![Source: WSIC](images/healthy_life/quintile_min_age_ltcs.png){fig-align="center"} -->
<!-- ::: -->
<!-- ::::: -->

## Preventable causes of death

Preventable mortality is a critical measure of population health as it reflects deaths that could have been avoided through effective public health interventions, timely medical care, or healthier lifestyle choices. The health equity team aims to reduce the overall preventable mortality and the difference between boroughs and smaller geographies. High rates of preventable mortality highlight unmet needs in healthcare, social conditions, and education, often underscoring inequalities within and between populations.

```{r preventable_mortality}
#| echo: false
#| error: false
premature_mortality <- fingertipsR::indicators(ProfileID = 125, proxy_settings = "none")


premature_mortality_disease_lad <- fingertips_data(IndicatorID = c(108), AreaTypeID = 501, proxy_settings = "none", AreaCode = nwl_code_list$lad_codes_21) %>% 
  janitor::clean_names()

premature_mortality_disease_compare <- fingertips_data(IndicatorID = c(108), AreaTypeID = 6, proxy_settings = "none", AreaCode = "E12000007") %>% 
  janitor::clean_names()

preventablable_msoa <- fingertips_data(IndicatorID = c(93480), AreaTypeID = 3, proxy_settings = "none", AreaCode = nwl_code_list$msoa_codes_11) %>% 
  janitor::clean_names() %>% 
  dplyr::filter(timeperiod_sortable==max(timeperiod_sortable))

lad_diff_pm <- premature_mortality_disease_lad %>% 
  filter(timeperiod_sortable==max(timeperiod_sortable)) %>% 
  group_by(sex) %>% 
  summarise(diff=max(value)-min(value))

msoa_diff_pm <- preventablable_msoa %>% 
  filter(timeperiod_sortable==max(timeperiod_sortable)) %>% 
  summarise(diff=max(value)-min(value))

premature_mortality_compare_clean <-premature_mortality_disease_compare %>% 
  dplyr::filter(sex!="Persons" & timeperiodrange=="1y") %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))) %>% 
  dplyr::select(year, sex, value, lower_ci95_0limit, upper_ci95_0limit) %>% 
  dplyr::mutate(is_national="London average")

premature_mortality_disease_lad_clean <- premature_mortality_disease_lad %>% 
  dplyr::bind_rows(premature_mortality_disease_compare) %>% 
  dplyr::filter(sex=="Persons" & timeperiodrange=="1y") %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))) %>% 
  dplyr::select(area_name, year, sex, value, lower_ci95_0limit, upper_ci95_0limit)

premature_mortality_nwl <- premature_mortality_disease_lad %>% 
  dplyr::filter(sex!="Persons" & timeperiodrange=="1y") %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))) %>% 
  dplyr::group_by(sex, year) %>% 
  dplyr::summarise(across(c(value, lower_ci95_0limit, upper_ci95_0limit), ~mean(.x, na.rm = TRUE)))  %>% 
  dplyr::mutate(is_national="NWL") %>% 
  dplyr::bind_rows(premature_mortality_compare_clean)

premature_mortality_inequality <- premature_mortality_disease_lad %>% 
  dplyr::filter(timeperiodrange=="1y") %>% 
  dplyr::mutate(year=as.numeric(gsub("0000", "", timeperiod_sortable))) %>% 
  dplyr::group_by(sex, year) %>% 
  dplyr::summarise(differnce=max(value)-min(value))

nwl_pm_shape <- msoa_shape %>% 
  left_join(preventablable_msoa,
            by=c("msoa11cd"="area_code")) %>% 
  sf::st_transform(crs = 4326) %>% 
  sf::st_simplify(dTolerance = 50) 


#93722, 93723, 93724

```

Between 2021 and 2023 preventable mortality has decreased in North West London along with the London and England average. Throughout this time the NWL preventable mortality rate has remained similar to the London average apart from in Males in 2020. The increase nationally and in NWL in 2020-2021 likely comes from the effects of the COVID-19 pandemic.

```{r preventable_mortality_time_series}
#| echo: false
#| fig-width: 10 
#| error: false
p5 <- premature_mortality_nwl %>% 
  dplyr::mutate(is_national=factor(is_national)) %>% 
  ggplot(aes(x=year, y=value, min=lower_ci95_0limit, ymax=upper_ci95_0limit)) +
  #geom_point(aes(color=sex)) +
  geom_line(aes(color=sex, linetype = is_national), show.legend =TRUE) +
  geom_ribbon(aes(fill=sex, alpha=is_national), show.legend =TRUE)+
  scale_color_manual(values = c("Female"="#41B6E6", "Male"="#009639")) +
  scale_fill_manual(values = c("Female"="#41B6E6", "Male"="#009639")) +
  scale_alpha_manual(values= c("NWL"=0.3, "London average"=0.5),
                    labels = c("NWL", "London average")) +  # <- Explicit Labels
  scale_x_continuous(breaks = seq(min(premature_mortality_nwl$year), max(premature_mortality_nwl$year),2)) +
  theme_classic() +
  labs(x="Year",
       y="Mortality rate per 100K population",
       color="",
       fill="",
       linetype="",
       alpha="",
       title="Preventable mortality (<75) in North West London",
       caption="Source: OHID")

ggplotly(p5, tooltip = c( "x", "y")) 


```
<br>
Despite this overall decrease and slightly lower rates than the London average, there remains a large disparity in preventable mortality between smaller geographies of NWL. Over the last 20 years there has been a consistent gap between the premature mortality of different boroughs with Hammersmith and Fulham has the highest preventable mortality rate where as K&C and Harrow have the lowest. Additionally, the gap between males is greater than the gap between female premature mortality. There is currently a `r sprintf("%.1f",  lad_diff_pm$diff[lad_diff_pm$sex=="Persons"])` difference in preventable mortality between boroughs and a `r sprintf("%.1f",  msoa_diff_pm$diff)` difference between small geographies MSOAs.

```{r LAD_preventable_mortality_time_series}
#| echo: false
#| fig-width: 10 
#| fig-height: 10
#| error: false
p6<-premature_mortality_disease_lad_clean %>% 
  ggplot(aes(x=year, y=value)) +
  geom_point(aes(color=area_name)) +
  geom_line(aes(color=area_name)) +
  #geom_ribbon(aes(ymin=lower_ci95_0limit, ymax=upper_ci95_0limit, fill=area_name, alpha=0.3), show.legend =FALSE)+
  scale_color_manual(values=c("Brent"="#4B429B","Ealing"="#2A90C0","Harrow"="#F9A50E","Hillingdon"="#F24678", "Hammersmith and Fulham" = "#853E9A", "Kensington and Chelsea" ="#69c44f","Westminster"="#F26A46", "Hounslow"="#C02A45","England"="grey20" )) +
  #scale_color_manual(values=c("#4B429B","#2A90C0", "#F9A50E","#F24678", "#853E9A", "#539A3E", "#F26A46", "#C02A45", "grey20" )) +

  scale_x_continuous(breaks = seq(min(premature_mortality_disease_lad_clean$year), max(premature_mortality_disease_lad_clean$year),2)) +
  theme_classic() +
  labs(x="Year",
       y="Mortality rate per 100K population",
       color="Sex",
       fill="Sex",
       linetype="",
       title="Preventable mortality (<75) in North West London",
       caption="Source: OHID")

p7<-premature_mortality_inequality %>% 
  dplyr::filter(sex!="Persons") %>% 
  ggplot(aes(x=year, y=differnce)) +
  geom_point(aes(color=sex)) +
  geom_line(aes(color=sex)) +
  scale_color_manual(values = c("Female"="#41B6E6", "Male"="#009639")) +
  scale_x_continuous(breaks = seq(min(life_expectancy_inequality$year), max(life_expectancy_inequality$year),2)) +
  theme_classic() +
  ylim(0,NA) +
  labs(x="Year",
       y="Difference mortality rate (per 100K)",
       color="Sex",
       fill="Sex",
       linetype="",
       title="Difference in premature mortality between NWL boroughs",
       caption="Source: OHID")


# Convert to ggplotly
p1_plotly <- ggplotly(p6)
p2_plotly <- ggplotly(p7)

# Arrange using subplot()
subplot(p1_plotly, p2_plotly, nrows = 2, shareX = TRUE, titleY=TRUE)


```

<br>
If we drill down to an even smaller geography, the map, shows the preventable death rate per 100,000 population under 75 for each NLW MSOA. Preventable deaths, included causes where public health interventions could potentially prevent all or most deaths. Notting Dale also has the highest rate of preventable deaths at 269 deaths, per 100,000 people, whereas Hans Town has the lowest a rate of preventable deaths at 17 per 100,000.

```{r preventable_mortality_maps}
#| echo: false
#| error: false
pal <- colorNumeric("viridis", domain = nwl_pm_shape$value, na.color = "transparent")
leaflet(nwl_pm_shape,  options = leafletOptions(preferCanvas = TRUE)) %>%
  addTiles() %>% 
  addPolygons(
    fillColor = ~pal(value),
    weight = 1,
    opacity = 0.5,
    color = "black",
    fillOpacity = 0.5,
    highlight = highlightOptions(weight = 3, color = "red", bringToFront = TRUE),
    label = ~paste0("Mortality rate: ", round(value, 1))
  ) %>%
  addLegend(
    pal = pal, values = ~value, title = "Preventable mortality all persons (2016-2020)", position = "bottomright"
  )
```

## Empowering communities to manage their health

```{r asc_admissions}
#| echo: false
#| error: false

asc <- read.csv("C:/nhs-nwl-icb-health-equity/health_equity_outcomes/data/asc_admissions_mar2025.csv") %>% 
  janitor::clean_names()# need to get from WSIC

asc_numerator <- asc %>% 
  dplyr::mutate(numerator=denominator*rate/100000) %>% 
  make_quintiles(imddecile)

asc_nwl<-  asc_numerator %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(across(c(numerator, denominator), ~sum(.x,na.rm=TRUE))) %>% 
  dplyr::group_by(year) %>% 
  PHEindicatormethods::phe_rate(numerator, denominator) 

asc_quinitle <-  asc_numerator %>% 
  dplyr::group_by(year, quintile) %>% 
  dplyr::summarise(across(c(numerator, denominator), ~sum(.x,na.rm=TRUE))) %>% 
  dplyr::group_by(year, quintile) %>% 
  PHEindicatormethods::phe_rate(numerator, denominator) 

asc_quinitle_diff <- asc_quinitle %>% 
  dplyr::filter(year!=max(asc_quinitle$year) & !is.na(quintile)) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(diff=max(value)-min(value))


asc_quinitle_diff_for_text <- asc_quinitle_diff %>% 
  dplyr::filter(year==2024) 
```

The health equity program aims to empower people to manage their health and therefore decrease the adverse preventable outcomes in people with LTCs. Equally, the aim is decrease the gap in the rate of these preventable outcomes between are most and least deprived communities. We can monitor some of these preventable outcomes by looking at ambulatory-sensitive condition (ASC) non-elective (NEL) admissions.

In North West London, the admissions rate has remained stable across all quintiles (the decrease in 2024 is likely due to a lag in reported data). However, there is a consistent difference in admission rate between the deprivation groups with the most deprived quintile (1) having the highest rates. Furthermore, the difference between deprivation groups has decreased since 2021 and is currently at `r sprintf("%.1f", asc_quinitle_diff_for_text$diff)`

```{r asc_admissions_plots}
#| echo: false
#| fig-width: 6 
#| error: false

p8<- asc_quinitle %>% 
  dplyr::filter(!is.na(quintile) & year!=2025) %>% 
  dplyr::mutate(quintile=factor(quintile)) %>% 
  ggplot(aes(x=year, y=value, ymin=lowercl, ymax=uppercl, color=factor(quintile), fill=factor(quintile))) +
  geom_line(aes()) +
  geom_ribbon(aes(), alpha =0.4, show.legend = FALSE) +
 scale_color_manual(name = "Deprivation (1=most deprived)",values = c("1"="#1b9e77", "2"="#d95f02", "3"="#7570b3", "4"="#e7298a", "5"="#66a61e")) +  # Adjust colors
  scale_fill_manual(name = "Deprivation (1=most deprived)", values = c("1"="#1b9e77", "2"="#d95f02", "3"="#7570b3", "4"="#e7298a", "5"="#66a61e")) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x="Year",
       y="Rate of admissions (per 100K)",
       title="NEL ASC admissions in North West London")

ggplotly(p8, tooltip = c("x", "y"))
```

```{r asc_admissions_plot_2}
asc_quinitle_diff %>%
  dplyr::filter(year!=2025) %>% 
  ggplot(aes(x=year, y=diff))+
  geom_col(fill="#005EB8") +
  theme_nwl() +
  labs(x="Year",
       y="Difference in rate of admissions (per 100K)",
       title="Difference in rate of admissions between the highest and lowest deprivation group")

```

## Experience of accessing healthcare

The health equity team aims to improve the experience of all heath care provision for the North West London population and also reduce the gap in positive experience between deprivation and ethnic groups. The [GP survey](https://gp-patient.co.uk/) collects data on experience of primary care and the health equity team is focusing on _“During your last appointment, how good was the healthcare professional at listening to you?”_ to represent experience of accessing care in the community.

In North West London, 188,495 questionnaires were sent out, and 36,153 were returned completed. This represents a response rate of 19%. The results show that NWL has a lower percentage of the population who feel listened to that the national average. Additionally there are disparities within deprivation, ethnicity and religion. The groups who felt they were the least listened to were those who did not disclose their ethnicity and religion.

![Source: GP Survey](images/gp_survey/icb_national_care_concern.png){fig-align="center"}

![Source: GP Survey](images/gp_survey/care_concern_deprivation.PNG){fig-align="center"}

![Source: GP Survey](images/gp_survey/care_concern_ethnicity.PNG){fig-align="center"}

![Source: GP Survey](images/gp_survey/care_concern_religion.PNG){fig-align="center"}

## Summary

The below table outlines the key population health outcomes for NWL residents, the current trends in these outcomes, inequality  and NWL health equity targets.

```{r summary}

life_expectancy_nwl_persons <- life_expectancy_nwl %>% 
  dplyr::group_by(year, is_national) %>% 
  dplyr::summarise(value=mean(value))

le <- life_expectancy_nwl_persons$value[life_expectancy_nwl_persons$year==max(life_expectancy_nwl_persons$year) & life_expectancy_nwl_persons$is_national=="NWL"]

le_ts <-  tail(life_expectancy_nwl_persons$value[life_expectancy_nwl_persons$is_national=="NWL"])

le_ineq_ts <- tail(lad_diff_le$diff, 5)

hle <- hle_50$min_age[hle_50$year==max(hle_50$year)]

hle_ts <- hle_50$min_age

hle_ineq_ts <- tail(hle_deprivation_50_current_diff$diff, 5)

pm_nwl_persons <- premature_mortality_nwl %>% 
  dplyr::group_by(year, is_national) %>% 
  dplyr::summarise(value=mean(value))

pm <- pm_nwl_persons$value[pm_nwl_persons$year==max(pm_nwl_persons$year)& pm_nwl_persons$is_national=="NWL"]

pm_ts <-  tail(pm_nwl_persons$value[pm_nwl_persons$is_national=="NWL"])

pm_ineq_ts <- tail(premature_mortality_inequality$differnce[premature_mortality_inequality$sex=="Persons"], 5)

a <- asc_nwl$value[asc_nwl$year==2024]

a_ts <- asc_nwl$value[asc_nwl$year!=2025]

a_ineq_ts <- tail(asc_quinitle_diff$diff, 5)




summary_table <- tibble(
  Outcome=c("Elongate healthy life as long as possible for people from our most deprived communities",
            "Elongate healthy life as long as possible for people from our most deprived communities",
            "Stop communities dying from causes that can be prevented and that are prevented in more affluent areas",
            "Enable and empower communities to manage their health so their health conditions do not affect their day-to-day life",
            "Improve the experience of accessing NHS healthcare for our most deprived communities"),
  Metric=c("Life expectancy (years)",
           "Healthy life expectancy (years)",
           "Preventable mortality (death per 100,000)",
           "Ambulatory sensitive preventable admissions (admissions per 100,000)",
           "% Good - During your last appointment, how good was the healthcare professional at listening to you?"),
  Value=c(le,
          hle,
          pm,
          a,
          83),
 Target=c("-",
          65,
          200,
          "-",
          "90"),
  Trend=list(le_ts,
                hle_ts,
                pm_ts,
                a_ts,
                NA
  ),
  Inequality=c(lad_diff_le$diff[lad_diff_le$year==max(lad_diff_le$year)],
               hle_deprivation_50_current_diff$diff[hle_deprivation_50_current_diff$year==max(hle_deprivation_50_current_diff$year)],
               premature_mortality_inequality$differnce[premature_mortality_inequality$sex=="Persons" & premature_mortality_inequality$year==max(premature_mortality_inequality$year)],
               asc_quinitle_diff_for_text$diff,
               4 ),
  `Target inequality`=c(5,
          5,
          50,
          200,
          0),
   `Trend inequality`=list(le_ineq_ts,
                hle_ineq_ts,
                pm_ineq_ts,
                a_ineq_ts,
                NA
  ),
  `Inequality Group`=c("Borough",
                       "Deprivation",
                       "Borough",
                       "Deprivation",
                       "Deprivation"))

```

```{r summary_table}
#| echo: false
#| fig-width: 15 
#| error: false

# Sample data (assuming "summary_table" exists)
summary_table <- summary_table %>%
  mutate(
    Value = round(Value, 1),          # Format Value to 1 dp
    Inequality = round(Inequality, 1) # Format Inequality to 1 dp
  )

summary_table %>%
  group_by(Outcome) %>% 
  gt() %>%
  tab_options(table.width = px(800)) %>%
  fmt_number(
    columns = c(Value, Inequality),
    decimals = 1
  ) %>%
  opt_table_outline() %>% 
  gt_plt_sparkline(Trend, same_limit = FALSE) %>% 
  gt_plt_sparkline(`Trend inequality`, same_limit = FALSE) %>% 
   tab_style(
    style = list(
      cell_text(weight = "bold"),
      cell_fill(color="#cce0f0")# Makes text bold
    ),
     locations = cells_row_groups()  # Targets Outcome column
  )


```
_** NB: the targets have been set based on informed estimation rather than formal quantitative analysis_

#### Population health  and inequalities targets 
There is still a need to improve population health outcomes and reduce inequalities in North West London. After declining over the last three years, life expectancy has increased to 82.5 over the last year and inequality between boroughs has decreased to 7.8 years. However there is still a  difference between boroughs and an even greater difference between smaller geographic areas. The healthy life expectancy has remained stable and the inequality gap remains around 9 years.

Since COVID-19 preventable mortality has decreased, and all NWL boroughs have lower rates that the national average, however rates have not decreased to pre-COVID-19 rates and in the last year we have seen an increase in inequality in the premature mortality between boroughs. We see consistent rates of poor outcomes for people managing their long term conditions, represented by preventable ASC admissions, however we do see a declining gap in these admissions between the most and least deprived. 

A factor that will influence a person health seeking behavior and therefore ability to mange their condition will be how they experience NHS service. Results for the GP survey show that 83% of the NWL population feel listened to by the GP, which is below national average. Furthermore, this varies by, ethnicity, religion and deprivation, with those who are more deprived having a lower score. 

Overall, although we are managing to keep these population health outcomes relatively stable, there is still work do in closing the inequality gap in these outcomes.



